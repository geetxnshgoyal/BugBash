<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/svg+xml" href="/assets/bugbash-logo.svg"/>
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png"/>
<link rel="icon" type="image/png" sizes="48x48" href="/assets/favicon-48.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="/assets/favicon-192.png"/>
<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/>
<link rel="icon" type="image/x-icon" href="/favicon.ico"/>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
<title>Bug Bash Admin</title>
<meta name="description" content="Secure Bug Bash admin dashboard for reviewing registrations and overseeing event operations.">
<link rel="canonical" href="https://bugbash.me/admin"/>
<meta property="og:type" content="website"/>
<meta property="og:title" content="Bug Bash Admin Console"/>
<meta property="og:description" content="Access the Bug Bash admin dashboard to manage registrations and event logistics."/>
<meta property="og:url" content="https://bugbash.me/admin"/>
<meta property="og:image" content="https://bugbash.me/assets/bugbash_logo.png"/>
<meta name="robots" content="noindex,nofollow"/>
<meta name="theme-color" content="#0f1720"/>
<meta name="author" content="Bug Bash team"/>
<script>
  window.si = window.si || function () {
    (window.siq = window.siq || []).push(arguments);
  };
</script>
<script defer src="https://va.vercel-scripts.com/v1/speed-insights/script.js" data-sdkn="@vercel/speed-insights" data-sdkv="1.2.0" data-route="/admin" data-endpoint="https://va.vercel-scripts.com/v1/speed-insights"></script>
<style>
  :root{--bg1:#0f1720;--bg2:#0b1020;--accent:#7be04a;--glass:rgba(255,255,255,0.08);--muted:#9aa6bf;--white:#f7f8fa;--shadow:0 12px 30px rgba(2,6,23,0.55);--danger:#f87171}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:
    radial-gradient(1200px 600px at 12% 8%, rgba(123,224,74,0.06), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--white)}
  #bg-canvas{position:fixed;inset:0;pointer-events:none;opacity:.7;z-index:0}
  .wrap{position:relative;z-index:2;max-width:1100px;margin:32px auto;padding:0 24px 64px;display:flex;flex-direction:column;gap:28px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
  header h1{font-size:28px;margin:0;font-weight:800;letter-spacing:.5px;display:flex;align-items:center;gap:12px}
  header h1::before{content:'üîí';font-size:24px;filter:drop-shadow(0 4px 10px rgba(123,224,74,0.5))}
  header a{color:var(--accent);text-decoration:none;font-size:14px;position:relative}
  header a:hover::after{content:'üöÄ';position:absolute;right:-20px;animation:float 1.4s ease-in-out infinite}
  .hero-stage{display:flex;justify-content:center;align-items:center;min-height:55vh;position:relative}
  .panel{position:relative;background:linear-gradient(180deg,var(--glass),transparent);border-radius:16px;padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(8px);overflow:hidden}
  .panel::after{content:'';position:absolute;inset:-35%;background:radial-gradient(circle,rgba(123,224,74,0.12) 0,rgba(123,224,74,0) 60%);opacity:0;animation:panel-glow 6.6s ease-in-out infinite;pointer-events:none}
  #login-card{max-width:420px;margin:0 auto}
  label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted);margin-bottom:16px}
  input[type=password]{padding:11px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);
    background:rgba(9,15,28,0.55);color:var(--white);font-size:15px}
  input[type=password]:focus{outline:2px solid rgba(123,224,74,0.55);outline-offset:1px}
  button{background:var(--accent);color:#061217;padding:11px 16px;border-radius:10px;border:none;font-weight:600;
    cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;font-size:15px;box-shadow:0 8px 20px rgba(123,224,74,0.16)}
  button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(123,224,74,0.22)}
  button.ghost{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.18);box-shadow:none}
  .status{font-size:13px;color:var(--muted);margin-top:12px;min-height:18px}
  .status.error{color:var(--danger)}
  #dashboard{display:none;flex-direction:column;gap:18px}
  .broadcast-card{margin:18px 0 6px;padding:20px;border-radius:14px;border:1px solid rgba(255,255,255,0.14);background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(11,16,32,0.35));box-shadow:0 18px 40px rgba(9,14,25,0.45);display:flex;flex-direction:column;gap:16px}
  .broadcast-card h2{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
  .broadcast-card h2::before{content:'‚úâÔ∏è'}
  .broadcast-card p.helper{margin:0;color:var(--muted);font-size:13px}
  .broadcast-card label{margin:0;font-size:13px;color:var(--muted)}
  .broadcast-card input[type=text],
  .broadcast-card input[type=email]{padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(9,15,28,0.55);color:var(--white);font-size:15px}
  .broadcast-card textarea{min-height:150px;resize:vertical;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.14);background:rgba(9,15,28,0.55);color:var(--white);font-size:15px;font-family:inherit;line-height:1.45}
  .broadcast-card input[type=text]:focus,
  .broadcast-card input[type=email]:focus,
  .broadcast-card textarea:focus{outline:2px solid rgba(123,224,74,0.5);outline-offset:1px}
  .broadcast-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  .broadcast-actions .test-send{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .broadcast-actions .test-send input{min-width:220px}
  .broadcast-preview{border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;background:rgba(9,15,28,0.4);font-size:14px;color:#e2e8f0;line-height:1.5}
  .broadcast-preview .preview-subject{font-weight:600;margin-bottom:10px;display:flex;gap:6px;align-items:center}
  .broadcast-preview .preview-subject span.label{opacity:.6;font-weight:500}
  .broadcast-preview .preview-body p{margin:0 0 12px}
  .checkin-card{margin:8px 0 14px;padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(13,20,35,0.4));display:flex;flex-direction:column;gap:16px}
  .checkin-card h2{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
  .checkin-card h2::before{content:'üéüÔ∏è'}
  .checkin-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .checkin-actions .manual{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .checkin-actions input[type=text]{min-width:220px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(9,15,28,0.55);color:var(--white);font-size:15px}
  .checkin-actions button{min-height:42px}
  #qrReader{width:100%;max-width:380px;min-height:260px;border-radius:12px;border:1px dashed rgba(255,255,255,0.18);background:rgba(10,16,28,0.65);display:flex;align-items:center;justify-content:center;overflow:hidden}
  #qrReader video{border-radius:12px;object-fit:cover;width:100%;height:100%}
  .checkin-status{font-size:14px}
  .checkin-meta{font-size:13px;color:var(--muted)}
  .table-wrap table tr.checked-in{background:rgba(34,197,94,0.08)}
  .table-wrap table tr.checked-in:hover{background:rgba(34,197,94,0.12)}
  .table-wrap table td .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 7px;border-radius:999px;background:rgba(255,255,255,0.1);margin-bottom:4px}
  .table-wrap table td .badge.success{background:rgba(34,197,94,0.18);color:#bbf7d0}
  .table-wrap table td .badge.warn{background:rgba(250,204,21,0.2);color:#fef3c7}
  .table-wrap table td button.qr-btn{padding:7px 10px;font-size:12px;border-radius:8px;background:rgba(123,224,74,0.12);color:#a3ff7a;border:1px solid rgba(123,224,74,0.35);cursor:pointer}
  .table-wrap table td button.qr-btn:hover{background:rgba(123,224,74,0.2)}
  .toolbar{display:flex;justify-content:space-between;gap:18px;flex-wrap:wrap;align-items:center}
  .toolbar strong{font-size:18px}
  .toolbar-actions{display:flex;gap:12px;flex-wrap:wrap}
  .toolbar-actions button,.toolbar-actions a{flex:0 0 auto}
  .toolbar-actions a{display:inline-flex;align-items:center;justify-content:center;padding:11px 16px;border-radius:10px;text-decoration:none;font-weight:600;transition:transform .2s ease,box-shadow .2s ease}
  .toolbar-actions a:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(123,224,74,0.22)}
  .toolbar-actions a.ghost{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.18)}
  .table-wrap{overflow-x:auto;border-radius:14px;border:1px solid rgba(255,255,255,0.08)}
  table{width:100%;border-collapse:collapse;min-width:900px;background:rgba(9,14,25,0.55);backdrop-filter:blur(4px);animation:fadeIn 0.6s ease}
  th,td{border-bottom:1px solid rgba(255,255,255,0.06);padding:12px 14px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
  tbody tr:hover{background:rgba(123,224,74,0.06)}
  .empty{padding:32px;text-align:center;color:var(--muted)}
  .pulse-btn{position:relative;overflow:hidden}
  .pulse-btn::after{content:'';position:absolute;inset:0;border-radius:inherit;border:1px solid rgba(123,224,74,0.45);opacity:0;transform:scale(0.7);animation:ring 4.8s linear infinite}
  @media(max-width:720px){header{flex-direction:column;align-items:flex-start;gap:12px}}
  @keyframes panel-glow{0%,100%{opacity:0;transform:scale(0.75)}40%{opacity:.32;transform:scale(1)}}
  @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  @keyframes ring{0%{opacity:.55;transform:scale(0.7)}60%{opacity:0;transform:scale(1.4)}100%{opacity:0;transform:scale(1.6)}}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
  @keyframes fadeIn{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div class="wrap">
  <header>
    <h1>Bug Bash Admin</h1>
    <a href="/">&larr; Back to site</a>
  </header>

  <section class="hero-stage">
    <div id="login-card" class="panel" style="max-width:400px;text-align:center">
      <h2 style="margin:0 0 12px;font-size:24px;letter-spacing:.02em">Admin login</h2>
      <p style="margin:0 0 16px;color:var(--muted);font-size:14px">Enter the admin access token to view registrations.</p>
      <p style="margin:0 0 24px;color:var(--muted);font-size:13px;opacity:.85">‚ÄúDeploy responsibly. Coffee helps.‚Äù ‚òïÔ∏è</p>
      <form id="loginForm" style="display:flex;flex-direction:column;gap:16px">
        <label style="margin:0;text-align:left">Access token
          <input id="adminToken" type="password" autocomplete="off" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </label>
        <button type="submit" style="align-self:center;width:120px">Sign in</button>
      </form>
      <div id="loginStatus" class="status" style="margin-top:16px;text-align:center"></div>
    </div>
  </section>

  <section id="dashboard" class="panel">
    <div class="toolbar">
      <div>
        <strong id="submissionCount">0 registrations</strong>
        <div id="status" class="status" style="margin-top:4px"></div>
        <div style="font-size:13px;color:var(--muted);margin-top:6px">Remember: <strong>#NoProdDeploysAfterMidnight</strong> üòé</div>
      </div>
      <div class="toolbar-actions">
        <button id="refreshBtn" class="pulse-btn" type="button">Refresh</button>
        <button id="csvBtn" class="ghost pulse-btn" type="button">Download CSV</button>
        <button id="logoutBtn" class="ghost" type="button">Log out</button>
      </div>
    </div>
    <div class="broadcast-card" id="emailPanel">
      <h2>Participant update email</h2>
      <p class="helper">Write an announcement and send it to every registered participant or run a test send first.</p>
      <label>Subject
        <input id="emailSubject" type="text" placeholder="Bug Bash schedule update" autocomplete="off">
      </label>
      <label>Message
        <textarea id="emailBody" placeholder="Hi team,\n\nHere's the latest on Bug Bash..."></textarea>
      </label>
      <div class="broadcast-actions">
        <div class="test-send">
          <input id="testEmail" type="email" placeholder="Send test to..." autocomplete="off" spellcheck="false">
          <button id="sendTestEmailBtn" class="ghost" type="button">Send test email</button>
        </div>
        <button id="sendBroadcastBtn" type="button">Send to all participants</button>
      </div>
      <div id="emailStatus" class="status"></div>
      <div class="broadcast-preview">
        <div class="preview-subject"><span class="label">Subject:</span> <span id="emailPreviewSubject"></span></div>
        <div id="emailPreviewBody" class="preview-body"></div>
      </div>
    </div>
    <div class="checkin-card" id="checkinPanel">
      <h2>Onsite check-in</h2>
      <p class="helper">Scan a participant&#39;s QR code or enter their registration ID to mark attendance.</p>
      <div class="checkin-actions">
        <button id="startScanBtn" type="button">Start scanner</button>
        <button id="stopScanBtn" class="ghost" type="button">Stop scanner</button>
        <div class="manual">
          <input id="manualCheckinInput" type="text" placeholder="Paste code or ID" autocomplete="off" spellcheck="false">
          <button id="manualCheckinBtn" type="button">Check in</button>
        </div>
        <button id="refreshCheckinsBtn" class="ghost" type="button">Refresh list</button>
      </div>
      <div id="qrReader" hidden>
        <span style="font-size:13px;color:var(--muted);">Camera initializing‚Ä¶</span>
      </div>
      <div id="checkinStatus" class="status checkin-status"></div>
      <div id="checkinMeta" class="checkin-meta"></div>
    </div>
    <div class="table-wrap">
      <table id="regTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Submitted</th>
            <th>Participant</th>
            <th>Email</th>
            <th>Phone</th>
            <th>DOB</th>
            <th>T-shirt size</th>
            <th>Heard via</th>
            <th>Notes</th>
            <th>Profile link</th>
            <th>IP</th>
            <th>Check-in</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="emptyState" class="empty" hidden>No registrations yet.</div>
    </div>
  </section>
</div>
<script src="/assets/html5-qrcode.min.js"></script>
<script>
/* background particles */
(()=>{
  const canvas=document.getElementById('bg-canvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let width=canvas.width=innerWidth;
  let height=canvas.height=innerHeight;
  const particles=[];
  const pulses=[];

  const random=(min,max)=>Math.random()*(max-min)+min;

  const rebuild=()=>{
    const count=Math.max(35,Math.floor((width*height)/70000));
    particles.length=0;
    for(let i=0;i<count;i++){
      particles.push({
        x:random(0,width),
        y:random(0,height),
        r:random(.6,2.6),
        vx:random(-.35,.55),
        vy:random(-.25,.4)
      });
    }
    const pulseCount=Math.max(4,Math.floor(width/320));
    pulses.length=0;
    for(let i=0;i<pulseCount;i++){
      pulses.push({
        x:random(0,width),
        y:random(0,height),
        radius:random(18,70),
        alpha:random(0.04,0.14),
        speed:random(0.32,0.5)
      });
    }
  };

  const resetPulse=pulse=>{
    pulse.x=random(0,width);
    pulse.y=random(0,height);
    pulse.radius=random(16,60);
    pulse.alpha=random(0.04,0.14);
    pulse.speed=random(0.3,0.5);
  };

  const resize=()=>{
    width=canvas.width=innerWidth;
    height=canvas.height=innerHeight;
    rebuild();
  };
  addEventListener('resize',resize);

  const render=()=>{
    ctx.clearRect(0,0,width,height);
    const gradient=ctx.createLinearGradient(0,0,width,height);
    gradient.addColorStop(0,'rgba(11,16,32,0.18)');
    gradient.addColorStop(1,'rgba(2,4,10,0.24)');
    ctx.fillStyle=gradient;
    ctx.fillRect(0,0,width,height);

    for(const pulse of pulses){
      pulse.radius+=pulse.speed;
      pulse.alpha-=0.0012;
      if(pulse.alpha<=0) resetPulse(pulse);
      const grd=ctx.createRadialGradient(pulse.x,pulse.y,0,pulse.x,pulse.y,pulse.radius);
      grd.addColorStop(0,`rgba(123,224,74,${pulse.alpha})`);
      grd.addColorStop(1,'rgba(123,224,74,0)');
      ctx.fillStyle=grd;
      ctx.beginPath();
      ctx.arc(pulse.x,pulse.y,pulse.radius,0,Math.PI*2);
      ctx.fill();
    }

    for(const p of particles){
      p.x+=p.vx;
      p.y+=p.vy;
      if(p.x<-20)p.x=width+20;
      if(p.x>width+20)p.x=-20;
      if(p.y<-20)p.y=height+20;
      if(p.y>height+20)p.y=-20;
      ctx.beginPath();
      ctx.fillStyle=`rgba(123,224,74,${0.065+p.r/6})`;
      ctx.shadowColor='rgba(123,224,74,0.22)';
      ctx.shadowBlur=5;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.shadowBlur=0;

    const limit=Math.min(particles.length,130);
    for(let i=0;i<limit;i++){
      const a=particles[i];
      for(let j=i+1;j<limit;j++){
        const b=particles[j];
        const dx=a.x-b.x;
        const dy=a.y-b.y;
        const distSq=dx*dx+dy*dy;
        if(distSq<8500){
          ctx.beginPath();
          ctx.strokeStyle=`rgba(123,224,74,${0.0025+(8500-distSq)/10500})`;
          ctx.lineWidth=0.7;
          ctx.moveTo(a.x,a.y);
          ctx.lineTo(b.x,b.y);
          ctx.stroke();
        }
      }
    }

    requestAnimationFrame(render);
  };

  rebuild();
  render();
})();

const loginCard=document.getElementById('login-card');
const dashboard=document.getElementById('dashboard');
const loginForm=document.getElementById('loginForm');
const adminTokenInput=document.getElementById('adminToken');
const loginStatus=document.getElementById('loginStatus');
const submissionCount=document.getElementById('submissionCount');
const statusEl=document.getElementById('status');
const tableBody=document.querySelector('#regTable tbody');
const emptyState=document.getElementById('emptyState');
const refreshBtn=document.getElementById('refreshBtn');
const logoutBtn=document.getElementById('logoutBtn');
const csvBtn=document.getElementById('csvBtn');
const emailSubjectInput=document.getElementById('emailSubject');
const emailBodyInput=document.getElementById('emailBody');
const testEmailInput=document.getElementById('testEmail');
const sendTestEmailBtn=document.getElementById('sendTestEmailBtn');
const sendBroadcastBtn=document.getElementById('sendBroadcastBtn');
const emailStatus=document.getElementById('emailStatus');
const emailPreviewSubject=document.getElementById('emailPreviewSubject');
const emailPreviewBody=document.getElementById('emailPreviewBody');
const startScanBtn=document.getElementById('startScanBtn');
const stopScanBtn=document.getElementById('stopScanBtn');
const manualCheckinInput=document.getElementById('manualCheckinInput');
const manualCheckinBtn=document.getElementById('manualCheckinBtn');
const refreshCheckinsBtn=document.getElementById('refreshCheckinsBtn');
const qrReaderEl=document.getElementById('qrReader');
const checkinStatus=document.getElementById('checkinStatus');
const checkinMeta=document.getElementById('checkinMeta');

let activeToken='';
let html5Qr=null;
let scannerActive=false;
let lastScanValue='';
let lastScanAt=0;
let registrationsCache=[];

const setStatus=(el,text,isError=false)=>{
  el.textContent=text||'';
  el.classList.toggle('error',Boolean(isError));
};

const formatDate=(value)=>{
  if(!value) return '';
  const parsed=Date.parse(value+'Z');
  if(Number.isNaN(parsed)) return value;
  return new Date(parsed).toLocaleString();
};

const escapeHtml=(txt)=>String(txt ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;');
const formatMultiLine=(txt)=>escapeHtml(txt).replace(/\n/g,'<br>');
const defaultPreviewHtml='<em style="color:var(--muted);">Message preview will appear here.</em>';
const buildPreviewHtml=txt=>{
  const value=String(txt||'').trim();
  if(!value) return defaultPreviewHtml;
  return value
    .split(/\n{2,}/g)
    .map(block=>`<p>${escapeHtml(block).replace(/\n/g,'<br>')}</p>`)
    .join('');
};
const updateEmailPreview=()=>{
  const subject=emailSubjectInput?.value.trim()||'(no subject yet)';
  if(emailPreviewSubject) emailPreviewSubject.textContent=subject;
  if(emailPreviewBody) emailPreviewBody.innerHTML=buildPreviewHtml(emailBodyInput?.value||'');
};

const renderRows=(rows=[])=>{
  tableBody.innerHTML='';
  if(!rows.length){
    emptyState.hidden=false;
    registrationsCache=[];
    return;
  }
  emptyState.hidden=true;
  registrationsCache=rows;
  tableBody.innerHTML=rows.map(row=>{
    const linkCell=row.profile_link?`<a href="${escapeHtml(row.profile_link)}" target="_blank" rel="noopener">Open</a>`:'';
    const created=formatDate(row.created_at||'');
    const phone=row.phone||'';
    const dob=row.dob||'';
    const size=row.tshirt_size||'';
    const heard=row.heard_from||row.problem||'';
    const checkedClass=row.checked_in_at?'checked-in':'';
    const checkinTime=row.checked_in_at?formatDate(row.checked_in_at):'';
    const checkinBadge=row.checked_in_at
      ? `<span class="badge success">Checked in</span><div>${escapeHtml(checkinTime)}</div>`
      : `<span class="badge warn">Pending</span>`;
    const checkinControls=`<button class="qr-btn" data-action="qr" data-id="${row.id}">QR</button>`;
    return `<tr data-id="${row.id}" class="${checkedClass}">
      <td>${row.id}</td>
      <td>${escapeHtml(created)}</td>
      <td>${escapeHtml(row.leader_name||'')}</td>
      <td>${escapeHtml(row.leader_email||'')}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(dob)}</td>
      <td>${escapeHtml(size)}</td>
      <td>${formatMultiLine(heard)}</td>
      <td>${formatMultiLine(row.notes||'')}</td>
      <td>${linkCell}</td>
      <td>${escapeHtml(row.ip||'')}</td>
      <td>${checkinControls}<br>${checkinBadge}</td>
    </tr>`;
  }).join('');
};

updateEmailPreview();
emailSubjectInput?.addEventListener('input',updateEmailPreview);
emailBodyInput?.addEventListener('input',updateEmailPreview);

const authHeaders=()=>activeToken?{Authorization:`Bearer ${activeToken}`}:{ };

const resetToLogin=(message='',isError=false)=>{
  activeToken='';
  dashboard.style.display='none';
  loginCard.parentElement.style.display='flex';
  loginCard.style.display='block';
  tableBody.innerHTML='';
  emptyState.hidden=true;
  submissionCount.textContent='0 registrations';
  setStatus(statusEl,'');
  setStatus(loginStatus,message,isError);
  if(emailSubjectInput) emailSubjectInput.value='';
  if(emailBodyInput) emailBodyInput.value='';
  if(testEmailInput) testEmailInput.value='';
  if(emailStatus) setStatus(emailStatus,'');
  if(sendBroadcastBtn) sendBroadcastBtn.disabled=false;
  if(sendTestEmailBtn) sendTestEmailBtn.disabled=false;
  stopScanner(true);
  if(checkinStatus) setStatus(checkinStatus,'');
  if(checkinMeta) checkinMeta.textContent='';
  updateEmailPreview();
};

const emailErrorMessages={
  missing_subject:'Add a subject before sending.',
  missing_body:'Write a message before sending.',
  email_not_configured:'Mail server is not configured on the server.',
  invalid_test_recipient:'Enter a valid test recipient email address.',
  no_recipients:'No participant emails found to send to.',
  test_send_failed:'Test email failed. Check the server logs.',
  broadcast_failed:'Broadcast failed. Check the server logs.',
  smtp_connection_failed:'Could not reach the SMTP server.',
  smtp_auth_failed:'SMTP authentication failed.',
  smtp_host_not_found:'SMTP host could not be resolved.',
  smtp_rejected:'SMTP server rejected the message.',
  smtp_envelope_error:'Invalid email sender or recipient.',
  smtp_unknown_error:'SMTP error occurred.'
};

const checkinErrorMessages={
  invalid_code:'QR code not recognized.',
  invalid_signature:'QR code signature is invalid.',
  missing_registration_id:'Enter or scan a registration ID first.',
  registration_not_found:'No registration found for that ID.',
  checkin_failed:'Check-in failed. Try again.'
};

const sendAdminEmail=async(mode)=>{
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return;
  }
  if(!emailSubjectInput||!emailBodyInput||!emailStatus){
    console.warn('Email panel not available');
    return;
  }
  const subject=emailSubjectInput.value.trim();
  const content=emailBodyInput.value;
  if(!subject){
    setStatus(emailStatus,emailErrorMessages.missing_subject,true);
    return;
  }
  if(!content.trim()){
    setStatus(emailStatus,emailErrorMessages.missing_body,true);
    return;
  }

  const payload={subject,content,mode};
  if(mode==='test'){
    const testAddress=testEmailInput?.value.trim()||'';
    if(!testAddress){
      setStatus(emailStatus,'Enter a test email address first.',true);
      return;
    }
    payload.testRecipient=testAddress;
  }

  const busyMessage=mode==='test'?'Sending test email...':'Sending email to all participants...';
  setStatus(emailStatus,busyMessage);
  sendBroadcastBtn.disabled=true;
  sendTestEmailBtn.disabled=true;

  const headers={...authHeaders(),'Content-Type':'application/json'};

  try{
    const res=await fetch('/api/admin/email/send',{
      method:'POST',
      headers,
      body:JSON.stringify(payload)
    });
    const data=await res.json().catch(()=>null);
    if(!res.ok||!data?.ok){
      const errKey=data?.error;
      let message=emailErrorMessages[errKey]||'Email send failed.';
      if(data?.details){
        message=`${message} (${data.details})`;
      }
      if(data?.hint){
        message=`${message} ${data.hint}`;
      }
      setStatus(emailStatus,message,true);
      if(data?.preview){
        if(data.preview.subject&&emailPreviewSubject){
          emailPreviewSubject.textContent=data.preview.subject;
        }
        if(data.preview.text&&emailPreviewBody){
          emailPreviewBody.innerHTML=buildPreviewHtml(data.preview.text);
        }else if(data.preview.html&&emailPreviewBody){
          emailPreviewBody.innerHTML=data.preview.html;
        }
      }
      return;
    }
    if(mode==='test'){
      setStatus(emailStatus,`Test email sent to ${payload.testRecipient}.`);
      if(data.preview){
        if(data.preview.subject&&emailPreviewSubject){
          emailPreviewSubject.textContent=data.preview.subject;
        }
        if(data.preview.text&&emailPreviewBody){
          emailPreviewBody.innerHTML=buildPreviewHtml(data.preview.text);
        }else if(data.preview.html&&emailPreviewBody){
          emailPreviewBody.innerHTML=data.preview.html;
        }
      }
    }else{
      const delivered=data.delivered ?? data.recipients ?? 0;
      const failed=data.failed ?? 0;
      const pluralDelivered=delivered===1?'participant':'participants';
      const pluralFailed=failed===1?'failure':'failures';
      const successMessage=failed
        ? `Sent to ${delivered} ${pluralDelivered} with ${failed} ${pluralFailed}.`
        : `Sent to ${delivered} ${pluralDelivered}.`;
      setStatus(emailStatus,successMessage,Boolean(failed));
    }
  }catch(err){
    console.error(err);
    setStatus(emailStatus,'Email send failed.',true);
  }finally{
    sendBroadcastBtn.disabled=false;
    sendTestEmailBtn.disabled=false;
  }
};

const updateScannerButtons=()=>{
  if(startScanBtn) startScanBtn.disabled=scannerActive;
  if(stopScanBtn) stopScanBtn.disabled=!scannerActive;
};

const stopScanner=async(silent=false)=>{
  if(html5Qr){
    try{
      if(scannerActive){
        await html5Qr.stop();
      }
      await html5Qr.clear();
    }catch(err){
      console.warn('Failed to stop scanner',err);
    }
    html5Qr=null;
  }
  scannerActive=false;
  if(qrReaderEl){
    qrReaderEl.hidden=true;
  }
  updateScannerButtons();
  if(!silent){
    setStatus(checkinStatus,'Scanner stopped.');
  }
};

const displayCheckinMeta=(registration={},status='')=>{
  if(!checkinMeta) return;
  if(!registration||!registration.id){
    checkinMeta.textContent='';
    return;
  }
  const name=registration.leader_name||registration.leader_email||registration.id;
  const statusText=status==='checked_in'
    ? `Checked in at ${formatDate(registration.checked_in_at)}`
    : registration.checked_in_at
    ? `Already checked in at ${formatDate(registration.checked_in_at)}`
    : 'Not checked in yet.';
  const lines=[
    `<strong>${escapeHtml(name)}</strong>`,
    `ID: ${escapeHtml(registration.id)}`,
    statusText?escapeHtml(statusText):''
  ].filter(Boolean);
  checkinMeta.innerHTML=lines.join('<br>');
};

const performCheckin=async({code='',registrationId='',source='manual'}={})=>{
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return;
  }
  const payload={};
  if(code) payload.code=code.trim();
  if(registrationId) payload.registrationId=registrationId.trim();
  if(!payload.code&&!payload.registrationId){
    setStatus(checkinStatus,checkinErrorMessages.missing_registration_id,true);
    return;
  }
  displayCheckinMeta(null);
  setStatus(checkinStatus,source==='qr'?'Scanning...':'Checking in...');
  try{
    const res=await fetch('/api/admin/checkins',{
      method:'POST',
      headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(res.status===401){
      resetToLogin('Session expired. Please sign in again.',true);
      return;
    }
    const data=await res.json().catch(()=>null);
    if(!res.ok||!data?.ok){
      const errKey=data?.error;
      const message=checkinErrorMessages[errKey]||'Check-in failed.';
      setStatus(checkinStatus,message,true);
      if(data?.details){
        checkinMeta.textContent=data.details;
      }
      return;
    }
    const registration=data.registration;
    if(data.status==='already_checked_in'){
      setStatus(checkinStatus,`Already checked in (${formatDate(registration.checked_in_at)}).`);
    }else{
      setStatus(checkinStatus,`Checked in ${registration.leader_name||registration.leader_email||registration.id}.`);
    }
    displayCheckinMeta(registration,data.status);
    manualCheckinInput.value='';
    lastScanValue='';
    await fetchRegistrations();
  }catch(err){
    console.error(err);
    setStatus(checkinStatus,'Check-in failed.',true);
  }
};

const handleScanResult=async(decodedText)=>{
  if(!decodedText) return;
  const now=Date.now();
  if(decodedText===lastScanValue && now-lastScanAt<2000) return;
  lastScanValue=decodedText;
  lastScanAt=now;
  await performCheckin({code:decodedText,source:'qr'});
};

const startScanner=async()=>{
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return;
  }
  if(scannerActive){
    setStatus(checkinStatus,'Scanner already running.');
    return;
  }
  if(!window.Html5Qrcode){
    setStatus(checkinStatus,'Scanner library not loaded. Check your connection.',true);
    return;
  }
  if(!qrReaderEl){
    setStatus(checkinStatus,'Scanner element missing.',true);
    return;
  }
  qrReaderEl.hidden=false;
  if(!html5Qr){
    html5Qr=new Html5Qrcode('qrReader');
  }
  try{
    await html5Qr.start(
      {facingMode:'environment'},
      {
        fps:10,
        qrbox:{width:260,height:260},
        formatsToSupport:window.Html5QrcodeSupportedFormats
          ? [Html5QrcodeSupportedFormats.QR_CODE]
          : undefined
      },
      handleScanResult,
      (errMsg)=>console.debug('QR scan warning',errMsg)
    );
    scannerActive=true;
    updateScannerButtons();
    setStatus(checkinStatus,'Scanner ready. Hold a QR code in front of the camera.');
  }catch(err){
    console.error('Failed to start scanner',err);
    await stopScanner(true);
    setStatus(checkinStatus,'Unable to access camera. Grant permission or use manual entry.',true);
  }
};

const downloadQr=async(registrationId)=>{
  if(!registrationId) return;
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return;
  }
  try{
    setStatus(checkinStatus,`Generating QR for ${registrationId}...`);
    const res=await fetch(`/api/admin/registrations/${encodeURIComponent(registrationId)}/qr`,{headers:authHeaders()});
    if(res.status===401){
      resetToLogin('Session expired. Please sign in again.',true);
      return;
    }
    if(!res.ok){
      throw new Error('Failed to download QR');
    }
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const link=document.createElement('a');
    link.href=url;
    link.download=`bugbash-checkin-${registrationId}.png`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
    setStatus(checkinStatus,`QR downloaded for ${registrationId}.`);
  }catch(err){
    console.error(err);
    setStatus(checkinStatus,'Failed to generate QR code.',true);
  }
};

const fetchRegistrations=async()=>{
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return false;
  }
  setStatus(statusEl,'Loading...');
  try{
    const res=await fetch('/api/admin/registrations',{headers:authHeaders()});
    if(res.status===401){
      resetToLogin('Session expired. Please sign in again.',true);
      return false;
    }
    if(!res.ok){
      throw new Error('Request failed');
    }
    const data=await res.json();
    submissionCount.textContent=`${data.length} registration${data.length===1?'':'s'}`;
    setStatus(statusEl,data.length?`Last updated ${new Date().toLocaleTimeString()}`:'');
    setStatus(loginStatus,'');
    renderRows(data);
    return true;
  }catch(err){
    console.error(err);
    setStatus(statusEl,'Failed to load registrations',true);
    return false;
  }
};

const enterDashboard=async()=>{
  const success=await fetchRegistrations();
  if(success){
    loginCard.parentElement.style.display='none';
    loginCard.style.display='none';
    dashboard.style.display='flex';
  }
};

loginForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const suppliedToken=adminTokenInput.value.trim();
  if(!suppliedToken){
    setStatus(loginStatus,'Enter the access token',true);
    return;
  }
  setStatus(loginStatus,'Verifying...');
  try{
    const res=await fetch('/api/admin/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:suppliedToken})
    });
    const payload=await res.json().catch(()=>null);
    if(!res.ok||!payload?.ok||!payload.token){
      const errKey=payload?.error;
      const messages={
        invalid_token:'Invalid token. Try again.',
        missing_token:'Enter the access token.',
        admin_credentials_not_set:'Admin token not configured on server.'
      };
      setStatus(loginStatus,messages[errKey]||'Login failed.',true);
      return;
    }
    activeToken=payload.token;
    adminTokenInput.value='';
    setStatus(loginStatus,'');
    await enterDashboard();
  }catch(err){
    console.error(err);
    setStatus(loginStatus,'Login failed. Try again.',true);
  }
});

sendTestEmailBtn?.addEventListener('click',async()=>{
  await sendAdminEmail('test');
});

sendBroadcastBtn?.addEventListener('click',async()=>{
  if(!confirm('Send this email to all registered participants?')) return;
  await sendAdminEmail('broadcast');
});

startScanBtn?.addEventListener('click',async()=>{
  await startScanner();
});

stopScanBtn?.addEventListener('click',async()=>{
  await stopScanner();
});

manualCheckinBtn?.addEventListener('click',async()=>{
  const value=manualCheckinInput?.value.trim()||'';
  if(!value){
    setStatus(checkinStatus,checkinErrorMessages.missing_registration_id,true);
    return;
  }
  await performCheckin({code:value,registrationId:value,source:'manual'});
});

manualCheckinInput?.addEventListener('keydown',async(e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    manualCheckinBtn?.click();
  }
});

refreshCheckinsBtn?.addEventListener('click',async()=>{
  await fetchRegistrations();
  setStatus(checkinStatus,'Check-in list refreshed.');
});

tableBody?.addEventListener('click',async(event)=>{
  const trigger=event.target.closest('[data-action="qr"]');
  if(!trigger) return;
  event.preventDefault();
  const id=trigger.dataset.id;
  if(!id) return;
  await downloadQr(id);
});

refreshBtn.addEventListener('click',async()=>{
  await fetchRegistrations();
});

csvBtn.addEventListener('click',async()=>{
  if(!activeToken){
    resetToLogin('Session expired. Please sign in again.',true);
    return;
  }
  setStatus(statusEl,'Preparing CSV...');
  try{
    const res=await fetch('/api/registrations.csv',{headers:authHeaders()});
    if(res.status===401){
      resetToLogin('Session expired. Please sign in again.',true);
      return;
    }
    if(!res.ok){
      throw new Error('Request failed');
    }
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const link=document.createElement('a');
    link.href=url;
    link.download='registrations.csv';
    document.body.appendChild(link);
    link.click();
    link.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1000);
    setStatus(statusEl,'CSV downloaded');
  }catch(err){
    console.error(err);
    setStatus(statusEl,'Failed to download CSV',true);
  }
});

logoutBtn.addEventListener('click',async()=>{
  if(activeToken){
    try{
      await fetch('/api/admin/logout',{method:'POST',headers:authHeaders()});
    }catch(err){
      console.warn('Logout request failed',err);
    }
  }
  resetToLogin('Logged out.');
});

sessionStorage.removeItem(STORAGE_KEY);
</script>
<script type="module" src="/assets/analytics.js"></script>
</body>
</html>
